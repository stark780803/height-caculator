<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°‘ç¿”æ©Ÿé›» - ç©¿æ¨‘é«˜å±¤è¨ˆç®—æ©Ÿ V17.4</title>
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif; 
            background-color: #f0f4f8; 
            display: flex; 
            justify-content: center; 
            margin: 0; 
            padding: 15px; 
            -webkit-tap-highlight-color: transparent; 
        }

        .container { 
            background: white; 
            padding: 25px; 
            border-radius: 16px; 
            box-shadow: 0 4px 25px rgba(0,0,0,0.08); 
            width: 100%; 
            max-width: 600px; 
            box-sizing: border-box;
            transition: max-width 0.3s ease; 
        }
        
        h2 { 
            color: #263238; 
            text-align: center; 
            margin-bottom: 20px; 
            border-bottom: 3px solid #00897b; 
            padding-bottom: 12px; 
            font-size: 1.5rem; 
        }

        /* --- Layout System --- */
        .layout-wrapper { display: block; }

        /* --- Components --- */
        .mode-switch {
            display: flex;
            background: #eceff1;
            padding: 5px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .mode-opt {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            font-weight: bold;
            color: #546e7a;
            transition: 0.3s;
        }
        .mode-opt.active {
            background: white;
            color: #00897b;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        
        .group-header {
            grid-column: span 2;
            font-size: 0.95rem;
            font-weight: bold;
            color: #555;
            background: #eee;
            padding: 5px 10px;
            border-radius: 6px;
            margin-top: 5px;
            display: flex; align-items: center; gap: 8px;
        }
        .badge-a { background: #2196f3; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
        .badge-b { background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }

        label { display: block; margin-bottom: 6px; font-weight: bold; color: #455a64; font-size: 0.9rem; }
        
        input, select { 
            width: 100%; padding: 10px; border: 2px solid #cfd8dc; border-radius: 8px; font-size: 16px; 
            box-sizing: border-box; background: #fff; -webkit-appearance: none; 
        }
        input:focus, select:focus { border-color: #00897b; outline: none; }
        .drop-input { border-color: #ffb74d; background: #fff8e1; }

        .slab-adj-group { display: flex; gap: 5px; }
        .slab-adj-group select { width: 45%; background: #fff8e1; border-color: #ffb74d; }
        .slab-adj-group input { width: 55%; border-color: #ffb74d; background: #fff8e1;}

        .hidden { display: none !important; }

        .main-btn { 
            width: 100%; padding: 15px; background-color: #00897b; color: white; border: none; 
            border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 10px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .main-btn:active { transform: scale(0.98); }

        .adjust-panel { display: none; background: #fff3e0; padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px solid #ffe0b2; }
        .adjust-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .adj-col { text-align: center; }
        .adj-col h4 { margin: 0 0 8px 0; font-size: 1rem; color: #444; }
        
        .adj-btn {
            width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; 
            font-size: 0.9rem; margin-bottom: 5px;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .btn-a.up { background: #bbdefb; color: #0d47a1; }
        .btn-a.down { background: #90caf9; color: #0d47a1; }
        .btn-b.up { background: #ffe0b2; color: #e65100; }
        .btn-b.down { background: #ffcc80; color: #e65100; }

        .offset-txt { font-size: 0.85rem; color: #666; font-weight: bold; margin-top: 5px; min-height: 1.2em;}

        .result-panel { 
            background: #e0f2f1; border-radius: 10px; margin-top: 20px; display: none; overflow: hidden; border: 1px solid #b2dfdb; 
        }
        
        .compare-table { width: 100%; border-collapse: collapse; }
        .compare-table th { background: #b2dfdb; color: #00695c; padding: 8px; font-size: 0.9rem; }
        .compare-table td { padding: 8px; border-bottom: 1px solid #cfd8dc; text-align: center; font-size: 1rem; vertical-align: middle; }
        .row-label { text-align: left !important; font-weight: bold; color: #455a64; font-size: 0.9rem; width: 35%; background: #f5f5f5; }
        .val-a { color: #1976d2; font-weight: bold; }
        .val-b { color: #f57c00; font-weight: bold; }
        
        .status-box { padding: 12px; text-align: center; font-weight: bold; font-size: 1rem; margin-top: 0; }
        
        /* åœ–ç¤ºå€ */
        .diagram-box { 
            margin-top: 20px; height: 420px; position: relative; 
            border: 2px solid #ddd; background: #fff; display: none; overflow: hidden; border-radius: 10px; 
            padding-left: 0; margin-bottom: 20px;
        }
        
        .beam-col { 
            position: absolute; right: 0; top: 30px; width: 50%; display: flex; flex-direction: column; 
            border-left: 3px solid #333; border-bottom: 3px solid #333; border-top: 2px solid #999;
            background: #eceff1; box-sizing: border-box; 
        }
        
        .abs-zone { position: absolute; left: 0; width: 100%; box-sizing: border-box; }
        .zone-slab { background: #cfd8dc; color: #455a64; font-weight: bold; border-bottom: 2px solid #455a64; z-index: 2; display:flex; align-items:center; justify-content:center; font-size:11px;}
        .zone-danger { background: rgba(198, 40, 40, 0.1); z-index: 1; }
        .zone-safe { 
            background: rgba(67, 160, 71, 0.2); 
            color: #2e7d32; font-weight: bold; 
            z-index: 1; 
            display:flex; align-items:center; justify-content:center; font-size:11px;
        }

        .limit-line {
            position: absolute; left: 0; width: 100%; height: 2px;
            background-image: linear-gradient(to right, #43a047 50%, transparent 50%);
            background-size: 10px 100%; 
            background-repeat: repeat-x;
            z-index: 3; 
        }

        /* ç®¡å­æ¨£å¼ */
        .sleeve-a { position: absolute; background: rgba(33, 150, 243, 0.15); border: 2px dashed #1976d2; border-radius: 50%; z-index: 10; left: 50%; transform: translate(-50%, -50%); transition: top 0.2s ease; }
        .pipe-a { position: absolute; background: rgba(33, 150, 243, 0.8); border: 1px solid #0d47a1; border-radius: 50%; z-index: 15; left: 50%; top: 50%; transform: translate(-50%, -50%); }
        .sleeve-b { position: absolute; background: rgba(255, 152, 0, 0.15); border: 2px dashed #f57c00; border-radius: 50%; z-index: 11; left: 65%; transform: translate(-50%, -50%); transition: top 0.2s ease; }
        .pipe-b { position: absolute; background: rgba(255, 152, 0, 0.8); border: 1px solid #e65100; border-radius: 50%; z-index: 16; left: 50%; top: 50%; transform: translate(-50%, -50%); }

        .center-dot {
            position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); z-index: 20;
        }

        .topping-visual { position: absolute; left: 130px; right: 50%; background: repeating-linear-gradient(45deg, #f0f0f0, #f0f0f0 5px, #e0e0e0 5px, #e0e0e0 10px); z-index: 1; border-bottom: 1px dashed #999; text-align: center; font-size: 10px; color: #666; display: flex; align-items: center; justify-content: center;}
        .slab-visual { position: absolute; left: 130px; right: 50%; background: #90a4ae; border-bottom: 1px solid #78909c; z-index: 2; color: #fff; font-size: 11px; display: flex; align-items: center; justify-content: center;}
        .ref-line-bs { position: absolute; left: 130px; width: 100%; border-bottom: 2px dotted #d84315; z-index: 5; }
        
        .dim-line-vertical { position: absolute; width: 1px; background: #555; display: flex; align-items: center; justify-content: center;}
        .dim-line-vertical::before { content: ''; position: absolute; width: 8px; height: 1px; background: #555; left: -3.5px; top: 0; }
        .dim-line-vertical::after { content: ''; position: absolute; width: 8px; height: 1px; background: #555; left: -3.5px; bottom: 0; }
        .break-symbol { position: absolute; bottom: 0; left: 130px; width: 100%; height: 10px; background: repeating-linear-gradient(45deg, #fff, #fff 2px, #ccc 2px, #ccc 4px); opacity: 0.5;}
        .dim-text-label { position: absolute; left: 2px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.95); padding: 1px 4px; font-size: 11px; font-weight: bold; color: #333; border: 1px solid #ccc; border-radius: 3px; white-space: nowrap; z-index: 20;}
        .fl-top-label { position: absolute; top: 5px; left: 132px; font-size: 12px; color: #333; font-weight: bold; z-index: 20; background: rgba(255,255,255,0.8); padding: 2px 5px; border-radius: 3px; border: 1px solid #ddd; }

        .bs-target-dot { position: absolute; width: 6px; height: 6px; background: #d84315; border-radius: 50%; left: -2px; bottom: -3px; z-index: 30; }

        .footer { text-align: center; margin-top: 20px; color: #90a4ae; font-size: 0.85rem; padding-bottom: 5px; letter-spacing: 0.5px; width: 100%; grid-column: span 2;}

        /* --- ğŸ’» é›»è…¦ç‰ˆ RWD --- */
        @media (min-width: 900px) {
            .container { max-width: 1100px; }
            .layout-wrapper { display: grid; grid-template-columns: 400px 1fr; gap: 30px; align-items: start; }
            .right-panel-wrapper { min-height: 100px; }
            .result-panel { margin-top: 0; } 
            .diagram-box { height: 500px; } 
        }

        /* --- ğŸ“± æ‰‹æ©Ÿç‰ˆ RWD --- */
        @media (max-width: 480px) {
            .input-grid { grid-template-columns: 1fr; gap: 8px; }
            .compare-table td, .compare-table th { padding: 6px; font-size: 0.9rem; }
            .row-label { width: 32%; }
            .sleeve-a { left: 40% !important; }
            .sleeve-b { left: 60% !important; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ—ï¸ å°‘ç¿”æ©Ÿé›» - ç©¿æ¨‘é«˜å±¤è¨ˆç®—æ©Ÿ</h2>
    
    <div class="layout-wrapper">
        
        <div class="left-panel-wrapper">
            <div class="mode-switch">
                <div class="mode-opt active" id="modeSingle" onclick="changeMode('single')">ğŸ”˜ å–®ç®¡æ¨¡å¼ (Single)</div>
                <div class="mode-opt" id="modeDual" onclick="changeMode('dual')">âšª é›™ç®¡æ¯”è¼ƒ (Dual)</div>
            </div>

            <div class="input-grid">
                <div class="group-header">ğŸ“ çµæ§‹åƒæ•¸ (å…±ç”¨)</div>
                <div><label>1. å±¤é«˜ (æ¿ä¸Š H)</label><input type="number" id="floorHeight" value="350" placeholder="350"></div>
                <div><label>2. æ¨‘æ·± (D)</label><input type="number" id="beamDepth" value="80"></div>
                <div><label>3. æ¿åš (T)</label><input type="number" id="slabThick" value="15"></div>
                
                <div style="grid-column: span 2;">
                    <label style="color:#ef6c00;">4. æ¿ä½èª¿æ•´ (Slab Offset)</label>
                    <div class="slab-adj-group">
                        <select id="dropType">
                            <option value="drop" selected>â¬‡ é™æ¿ (Drop)</option>
                            <option value="rise">â¬† å‡æ¿ (Rise)</option>
                        </select>
                        <input type="number" id="slabDrop" placeholder="è¼¸å…¥é«˜åº¦ (cm)" value="0" inputmode="numeric">
                    </div>
                </div>

                <div class="group-header" id="headerA"><span class="badge-a">ç®¡ A</span> è—è‰² (Blue)</div>
                <div id="inputA1">
                    <label>å¥—ç®¡å°ºå¯¸ (å¤–å¾‘)</label>
                    <select id="sleeveA">
                        <option value="6">2" (6cm)</option>
                        <option value="9">3" (9cm)</option>
                        <option value="12">4" (12cm)</option>
                        <option value="14">5" (14cm)</option>
                        <option value="17" selected>6" (17cm)</option>
                        <option value="22">8" (22cm)</option>
                        <option value="28">10" (28cm)</option>
                    </select>
                </div>
                <div id="inputA2">
                    <label>æœ¬ç®¡å°ºå¯¸ (å…§å¾‘)</label>
                    <select id="pipeA">
                        <option value="2">1/2" (2cm)</option>
                        <option value="3">3/4" (3cm)</option>
                        <option value="4">1" (4cm)</option>
                        <option value="5">1-1/2" (5cm)</option>
                        <option value="6">2" (6cm)</option>
                        <option value="8">2-1/2" (8cm)</option>
                        <option value="9">3" (9cm)</option>
                        <option value="12" selected>4" (12cm)</option>
                        <option value="14">5" (14cm)</option>
                        <option value="17">6" (17cm)</option>
                    </select>
                </div>

                <div class="group-header hidden" id="headerB"><span class="badge-b">ç®¡ B</span> æ©˜è‰² (Orange)</div>
                <div class="hidden" id="inputB1">
                    <label>å¥—ç®¡å°ºå¯¸ (å¤–å¾‘)</label>
                    <select id="sleeveB">
                        <option value="6" selected>2" (6cm)</option>
                        <option value="9">3" (9cm)</option>
                        <option value="12">4" (12cm)</option>
                        <option value="14">5" (14cm)</option>
                        <option value="17">6" (17cm)</option>
                        <option value="22">8" (22cm)</option>
                        <option value="28">10" (28cm)</option>
                    </select>
                </div>
                <div class="hidden" id="inputB2">
                    <label>æœ¬ç®¡å°ºå¯¸ (å…§å¾‘)</label>
                    <select id="pipeB">
                        <option value="2">1/2" (2cm)</option>
                        <option value="3">3/4" (3cm)</option>
                        <option value="4">1" (4cm)</option>
                        <option value="5">1-1/2" (5cm)</option>
                        <option value="6">2" (6cm)</option>
                        <option value="8">2-1/2" (8cm)</option>
                        <option value="9">3" (9cm)</option>
                        <option value="12">4" (12cm)</option>
                        <option value="14">5" (14cm)</option>
                        <option value="17">6" (17cm)</option>
                    </select>
                </div>
            </div>

            <button class="main-btn" onclick="startCalculation()">âš¡ é–‹å§‹è¨ˆç®—</button>

            <div class="adjust-panel" id="adjustPanel">
                <div class="adjust-grid">
                    <div class="adj-col" style="grid-column: span 2;" id="colA">
                        <h4 style="color:#1565c0;">ç®¡ A å¾®èª¿</h4>
                        <div style="display:flex; gap:10px;">
                            <button class="adj-btn btn-a up" onclick="adjustOffset('A', -1)">â¬† ä¸Šç§» 1cm</button>
                            <button class="adj-btn btn-a down" onclick="adjustOffset('A', 1)">â¬‡ ä¸‹ç§» 1cm</button>
                        </div>
                        <div class="offset-txt" id="offsetA">è²¼é½Šä¸Šé™</div>
                    </div>
                    
                    <div class="adj-col hidden" id="colB">
                        <h4 style="color:#e65100;">ç®¡ B å¾®èª¿</h4>
                        <div style="display:flex; gap:10px;">
                            <button class="adj-btn btn-b up" onclick="adjustOffset('B', -1)">â¬† ä¸Šç§» 1cm</button>
                            <button class="adj-btn btn-b down" onclick="adjustOffset('B', 1)">â¬‡ ä¸‹ç§» 1cm</button>
                        </div>
                        <div class="offset-txt" id="offsetB">è²¼é½Šä¸Šé™</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel-wrapper">
            <div class="result-panel" id="resultPanel">
                <div class="status-box" id="statusBox"></div>

                <table class="compare-table">
                    <thead>
                        <tr>
                            <th style="width:30%">é …ç›®</th>
                            <th style="color:#0d47a1;">ç®¡ A</th>
                            <th style="color:#e65100;" class="col-b hidden">ç®¡ B</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td class="row-label" colspan="3" style="text-align:center!important; background:#e0f7fa;">ğŸ‘· ç¾å ´æ”¾æ¨£ (B.S.)</td></tr>
                        <tr>
                            <td class="row-label">å¥—ç®¡ç®¡é ‚</td>
                            <td class="val-a" id="resBsTopA"></td>
                            <td class="val-b col-b hidden" id="resBsTopB"></td>
                        </tr>
                        <tr>
                            <td class="row-label" style="text-decoration: underline;">å¥—ç®¡ç®¡å¿ƒ</td>
                            <td class="val-a" id="resBsCenA" style="font-size:1.2rem;"></td>
                            <td class="val-b col-b hidden" id="resBsCenB" style="font-size:1.2rem;"></td>
                        </tr>
                        <tr>
                            <td class="row-label">å¥—ç®¡ç®¡åº•</td>
                            <td class="val-a" id="resBsBotA"></td>
                            <td class="val-b col-b hidden" id="resBsBotB"></td>
                        </tr>

                        <tr><td class="row-label" colspan="3" style="text-align:center!important; background:#fff3e0;">ğŸ“ çµ•å°é«˜ç¨‹ (FL+)</td></tr>
                        <tr>
                            <td class="row-label">æœ¬ç®¡ç®¡é ‚</td>
                            <td class="val-a" id="resTopA"></td>
                            <td class="val-b col-b hidden" id="resTopB"></td>
                        </tr>
                        <tr>
                            <td class="row-label">æœ¬ç®¡ç®¡å¿ƒ</td>
                            <td class="val-a" id="resCenA"></td>
                            <td class="val-b col-b hidden" id="resCenB"></td>
                        </tr>
                        <tr>
                            <td class="row-label">æœ¬ç®¡ç®¡åº•</td>
                            <td class="val-a" id="resBotA"></td>
                            <td class="val-b col-b hidden" id="resBotB"></td>
                        </tr>
                    </tbody>
                </table>
                <div style="padding:8px; font-size:0.9rem; color:#666; text-align:center;">
                    å®‰å…¨å€: FL+<span id="safeRange"></span><br>
                    <span style="color:#004d40; font-weight:bold;">æ¨“é«˜(æ¿ä¸‹): <span id="lblRoomH_res"></span> | æ¨‘ä¸‹æ·¨é«˜: <span id="lblClearH_res"></span></span>
                </div>
            </div>

            <div class="diagram-box" id="diagram">
                <div class="beam-col" id="beamVisual"></div>
                <div id="leftStructure"></div>
                <div class="ref-line-bs" id="slabLine">
                    <span style="position:absolute; right:100%; top:-12px; font-size:12px; color:#d84315; white-space:nowrap; font-weight:bold;" id="bsLabel">æ¿åº•</span>
                </div>
                
                <div class="fl-top-label">â‰ æ¿é ‚ FL+<span id="labelH"></span></div>

                <div id="storyHeightDim" class="dim-line-vertical" style="left: 15px;">
                    <div class="dim-text-label" style="left: 5px;">å±¤é«˜ <span id="lblStoryH"></span></div>
                </div>

                <div id="roomHeightDim" class="dim-line-vertical" style="left: 75px;">
                    <div class="dim-text-label" style="left: 5px;">æ¨“é«˜ <span id="lblRoomH"></span></div>
                </div>

                <div id="clearHeightDim" class="dim-line-vertical" style="left: 85%;">
                    <div class="dim-text-label" style="left: 5px;">æ·¨é«˜ <span id="lblClearH"></span></div>
                </div>

                <div id="bsVisualLayer" style="position:absolute; width:100%; height:100%; pointer-events:none;"></div>
                
                <div class="break-symbol"></div>
                <div style="position: absolute; bottom: 15px; left: 15px; font-size: 11px; color: #666;">âŠ å¾€åœ°é¢ (FL)</div>
            </div>
        </div>
    </div>

    <div class="footer">
        Presented by <strong>Stark</strong>
    </div>
</div>

<script>
    var currentMode = 'single';
    var g_offsetA = 0;
    var g_offsetB = 0;

    function changeMode(mode) {
        currentMode = mode;
        
        document.getElementById('modeSingle').className = (mode === 'single') ? 'mode-opt active' : 'mode-opt';
        document.getElementById('modeDual').className = (mode === 'dual') ? 'mode-opt active' : 'mode-opt';

        const elsToToggle = ['headerB', 'inputB1', 'inputB2', 'colB'];
        elsToToggle.forEach(id => {
            const el = document.getElementById(id);
            if(mode === 'single') el.classList.add('hidden');
            else el.classList.remove('hidden');
        });

        const colA = document.getElementById('colA');
        if(mode === 'single') {
            colA.style.gridColumn = "span 2"; 
        } else {
            colA.style.gridColumn = "span 1"; 
        }

        const colBs = document.querySelectorAll('.col-b');
        colBs.forEach(el => {
            if(mode === 'single') el.classList.add('hidden');
            else el.classList.remove('hidden');
        });

        document.getElementById('resultPanel').style.display = 'none';
        document.getElementById('diagram').style.display = 'none';
        document.getElementById('adjustPanel').style.display = 'none';
        g_offsetA = 0;
        g_offsetB = 0;
    }

    function startCalculation() {
        g_offsetA = 0;
        g_offsetB = 0;
        runUpdate();
    }

    function adjustOffset(pipe, delta) {
        // æ–°å¢ï¼šé åˆ¤é‚è¼¯ - è‹¥ä¸‹ç§»æœƒè¶…å‡ºå®‰å…¨ä¸‹é™ï¼Œå‰‡ä¸åŸ·è¡Œ
        var H = Number(document.getElementById('floorHeight').value);
        var D = Number(document.getElementById('beamDepth').value);
        var T = Number(document.getElementById('slabThick').value);
        var dropVal = Number(document.getElementById('slabDrop').value);
        var dropType = document.getElementById('dropType').value;
        if(dropVal < 0) dropVal = 0;
        var offsetVal = (dropType === 'drop') ? dropVal : -dropVal;
        
        var SA = Number(document.getElementById('sleeveA').value);
        var SB = Number(document.getElementById('sleeveB').value);
        
        // è¨ˆç®—å®‰å…¨ä¸‹é™
        var oneThird = Math.ceil(D / 3);
        var safeBotFL = H - (oneThird * 2); // å®‰å…¨å€åº•éƒ¨é«˜ç¨‹
        
        // è¨ˆç®—ç‰©ç†ä¸Šé™
        var safeTopFL = H - oneThird;
        var slabBotFL = H - T - offsetVal;
        var limitTop = Math.min(safeTopFL, slabBotFL);
        
        var currentOffset, sleeveDia;
        if (pipe === 'A') {
            currentOffset = g_offsetA;
            sleeveDia = SA;
        } else {
            currentOffset = g_offsetB;
            sleeveDia = SB;
        }
        
        var newOffset = currentOffset + delta;
        
        // æª¢æŸ¥ä¸Šç•Œ
        if (newOffset < 0) newOffset = 0;
        
        // æª¢æŸ¥ä¸‹ç•Œï¼šå¦‚æœé€™æ¬¡ç§»å‹•æœƒå°è‡´ å¥—ç®¡åº• < å®‰å…¨å€åº•ï¼Œä¸”æ˜¯æŒ‰ä¸‹ç§» (delta > 0)ï¼Œå‰‡ç¦æ­¢
        // Pipe Bottom FL = (limitTop - newOffset) - sleeveDia
        var nextBotFL = (limitTop - newOffset) - sleeveDia;
        
        if (nextBotFL < safeBotFL && delta > 0) {
            // é˜»æ“‹æ“ä½œï¼Œä¸æ›´æ–° offset
            return;
        }
        
        // é€šéæª¢æŸ¥ï¼Œæ›´æ–°è®Šæ•¸
        if (pipe === 'A') g_offsetA = newOffset;
        else g_offsetB = newOffset;
        
        runUpdate();
    }

    function runUpdate() {
        try {
            var H = Number(document.getElementById('floorHeight').value);
            var D = Number(document.getElementById('beamDepth').value);
            var T = Number(document.getElementById('slabThick').value);
            var dropVal = Number(document.getElementById('slabDrop').value);
            var dropType = document.getElementById('dropType').value; 
            
            if(dropVal < 0) dropVal = 0;
            var offsetVal = (dropType === 'drop') ? dropVal : -dropVal;

            var SA = Number(document.getElementById('sleeveA').value);
            var PA = Number(document.getElementById('pipeA').value);
            
            if(!H || !D || !T || !SA || !PA) {
                alert("è«‹è¼¸å…¥çµæ§‹èˆ‡ç®¡ A æ•¸å€¼"); return;
            }

            var oneThird = Math.ceil(D / 3); // ç„¡æ¢ä»¶é€²ä½
            var safeTopFL = H - oneThird;
            var safeBotFL = H - (oneThird * 2);
            var slabBotFL = H - T - offsetVal;
            var limitTop = Math.min(safeTopFL, slabBotFL);
            var clearHeight = H - D;
            var roomHeight = slabBotFL; 

            // è¨ˆç®— A
            var sTopA = limitTop - g_offsetA;
            var sCenA = sTopA - (SA / 2);
            var sBotA = sTopA - SA;
            var pCenA = sCenA;
            var pTopA = pCenA + (PA/2);
            var pBotA = pCenA - (PA/2);

            // B.S. è¨ˆç®— (A)
            var bsTopA = slabBotFL - sTopA;
            var bsCenA = slabBotFL - sCenA;
            var bsBotA = slabBotFL - sBotA;

            var isUnsafeA = false;
            var isUnsafeB = false;
            var statusMsg = "âœ… å®‰å…¨ Pass";
            var statusColor = "#2e7d32";
            var statusBg = "#e8f5e9";

            if (sBotA < safeBotFL) {
                statusMsg = "âŒ ç®¡ A è¶…å‡ºå®‰å…¨ä¸‹ç·£";
                statusColor = "#c62828";
                statusBg = "#ffebee";
            }
            if (SA > oneThird) {
                 statusMsg = "âŒ å±éšªï¼å¥—ç®¡ A éå¤§";
                 statusColor = "#c62828";
                 statusBg = "#ffebee";
            }

            // Bè®Šæ•¸åˆå§‹åŒ–
            var SB=0, PB=0, bsTopB=0, bsCenB=0, bsBotB=0, pTopB=0, pCenB=0, pBotB=0, sTopB=0, sCenB=0, sBotB=0;

            if (currentMode === 'dual') {
                SB = Number(document.getElementById('sleeveB').value);
                PB = Number(document.getElementById('pipeB').value);
                if(!SB || !PB) SB = 6, PB = 3; 

                sTopB = limitTop - g_offsetB;
                sCenB = sTopB - (SB / 2);
                sBotB = sTopB - SB;
                pCenB = sCenB;
                pTopB = pCenB + (PB/2);
                pBotB = pCenB - (PB/2);
                
                bsTopB = slabBotFL - sTopB;
                bsCenB = slabBotFL - sCenB;
                bsBotB = slabBotFL - sBotB;

                if (sBotB < safeBotFL) {
                    statusMsg += " | âŒ ç®¡ B è¶…å‡ºä¸‹ç·£";
                    statusColor = "#c62828";
                    statusBg = "#ffebee";
                }
                if (SB > oneThird) {
                     statusMsg += " | âŒ å¥—ç®¡ B éå¤§";
                }

                // å‚ç›´æ·¨è·
                var verticalOverlap = false;
                var clearance = 0;
                if (pBotA < pTopB && pTopA > pBotB) {
                    verticalOverlap = true;
                } else {
                    clearance = (pBotA >= pTopB) ? (pBotA - pTopB) : (pBotB - pTopA);
                }

                if (verticalOverlap) {
                    statusMsg = "âš ï¸ æœ¬ç®¡é«˜ç¨‹é‡ç–Š (è‹¥åå­—äº¤å‰æœƒæ’)";
                    statusColor = "#ef6c00";
                    statusBg = "#fff3e0";
                } else {
                    statusMsg = "âœ… æœ¬ç®¡å‚ç›´æ·¨è·: " + clearance.toFixed(1) + " cm";
                    statusColor = "#2e7d32";
                    statusBg = "#e8f5e9";
                }
            }

            // UI æ›´æ–°: å¢åŠ æ˜¯å¦åˆ°é”ä¸‹é™çš„æç¤º
            var limitReachedA = (sBotA <= safeBotFL); // å…¶å¯¦æ˜¯ ==ï¼Œä½†ç”¨ <= ä¿éšª
            var txtA = (g_offsetA===0) ? "è²¼é½Šä¸Šé™" : "é™ " + g_offsetA + "cm";
            if (limitReachedA) txtA += " <span style='color:#c62828'>(å·²é”å®‰å…¨ä¸‹é™)</span>";
            document.getElementById('offsetA').innerHTML = txtA;

            var limitReachedB = (sBotB <= safeBotFL);
            var txtB = (g_offsetB===0) ? "è²¼é½Šä¸Šé™" : "é™ " + g_offsetB + "cm";
            if (currentMode === 'dual' && limitReachedB) txtB += " <span style='color:#c62828'>(å·²é”å®‰å…¨ä¸‹é™)</span>";
            document.getElementById('offsetB').innerHTML = txtB;
            
            document.getElementById('resBsTopA').innerText = Math.round(bsTopA) + " cm";
            document.getElementById('resBsCenA').innerText = Math.round(bsCenA) + " cm";
            document.getElementById('resBsBotA').innerText = Math.round(bsBotA) + " cm";

            document.getElementById('resTopA').innerText = Math.round(pTopA);
            document.getElementById('resCenA').innerText = Math.round(pCenA);
            document.getElementById('resBotA').innerText = Math.round(pBotA);

            if (currentMode === 'dual') {
                
                document.getElementById('resBsTopB').innerText = Math.round(bsTopB) + " cm";
                document.getElementById('resBsCenB').innerText = Math.round(bsCenB) + " cm";
                document.getElementById('resBsBotB').innerText = Math.round(bsBotB) + " cm";

                document.getElementById('resTopB').innerText = Math.round(pTopB);
                document.getElementById('resCenB').innerText = Math.round(pCenB);
                document.getElementById('resBotB').innerText = Math.round(pBotB);
            }

            document.getElementById('safeRange').innerText = Math.round(safeBotFL) + "~" + Math.round(safeTopFL);
            
            document.getElementById('labelH').innerText = H;
            document.getElementById('lblStoryH').innerText = H;
            document.getElementById('lblRoomH').innerText = roomHeight;
            document.getElementById('lblClearH').innerText = clearHeight;
            
            document.getElementById('lblRoomH_res').innerText = roomHeight + "cm";
            document.getElementById('lblClearH_res').innerText = clearHeight + "cm";

            var bsLabelText = "æ¿åº•";
            if (dropVal > 0) {
                bsLabelText = (dropType === 'drop') ? "é™æ¿åº•" : "å‡æ¿åº•";
            }
            document.getElementById('bsLabel').innerText = bsLabelText;

            var statBox = document.getElementById('statusBox');
            statBox.innerText = statusMsg;
            statBox.style.color = statusColor;
            statBox.style.backgroundColor = statusBg;

            document.getElementById('adjustPanel').style.display = 'block';
            document.getElementById('resultPanel').style.display = 'block';
            document.getElementById('diagram').style.display = 'block';

            drawDiagram(D, T, offsetVal, SA, PA, SB, PB, bsCenA, bsCenB, isUnsafeA, isUnsafeB, oneThird);
            
        } catch(e) {
            console.error(e);
            alert("è¨ˆç®—ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ•¸å€¼");
        }
    }

    function drawDiagram(D, T, offsetVal, SA, PA, SB, PB, bsA, bsB, isUnsafeA, isUnsafeB, oneThirdVal) {
        var wrapper = document.getElementById('beamVisual');
        wrapper.innerHTML = '';
        var leftStruct = document.getElementById('leftStructure');
        leftStruct.innerHTML = '';
        var bsLayer = document.getElementById('bsVisualLayer');
        bsLayer.innerHTML = '';

        var displayRangeCm = D * 1.5; 
        var boxHeight = 400; 
        var scale = boxHeight / displayRangeCm; 
        if (!isFinite(scale) || scale <= 0) scale = 1;

        var beamPx = D * scale;
        var slabPx = T * scale;
        var offsetPx = offsetVal * scale; 
        var oneThirdPx = oneThirdVal * scale; 
        var topOffset = 30; 
        
        wrapper.style.height = beamPx + 'px';
        wrapper.style.top = topOffset + 'px'; 
        
        // çµæ§‹
        var slabDiv = document.createElement('div');
        slabDiv.className = 'abs-zone zone-slab';
        slabDiv.style.height = slabPx + 'px';
        slabDiv.style.top = '0px'; 
        slabDiv.innerText = "æ¿";
        wrapper.appendChild(slabDiv);

        var topDangerH = oneThirdVal - T; 
        if (topDangerH > 0) {
            var divDangerTop = document.createElement('div');
            divDangerTop.className = 'abs-zone zone-danger';
            divDangerTop.style.top = '0px';
            divDangerTop.style.height = oneThirdPx + 'px';
            wrapper.appendChild(divDangerTop);
        }

        var divSafe = document.createElement('div');
        divSafe.className = 'abs-zone zone-safe';
        divSafe.style.top = oneThirdPx + 'px';
        divSafe.style.height = oneThirdPx + 'px';
        divSafe.innerText = "å®‰å…¨å€";
        wrapper.appendChild(divSafe);

        // å®‰å…¨å€ç•Œç·š
        var lineTop = document.createElement('div');
        lineTop.className = 'limit-line';
        lineTop.style.top = (oneThirdPx - 2) + 'px';
        wrapper.appendChild(lineTop);

        var twoThirdPx = oneThirdPx * 2;
        var lineBot = document.createElement('div');
        lineBot.className = 'limit-line';
        lineBot.style.top = twoThirdPx + 'px';
        wrapper.appendChild(lineBot);

        var divDangerBot = document.createElement('div');
        divDangerBot.className = 'abs-zone zone-danger';
        divDangerBot.style.top = twoThirdPx + 'px';
        divDangerBot.style.height = oneThirdPx + 'px';
        wrapper.appendChild(divDangerBot);

        // å·¦å´çµæ§‹
        if (offsetVal > 0) {
            var topping = document.createElement('div');
            topping.className = 'topping-visual';
            topping.style.height = offsetPx + 'px';
            topping.style.top = topOffset + 'px'; 
            topping.innerText = "å¢ç¯‰";
            leftStruct.appendChild(topping);
            
            var leftSlab = document.createElement('div');
            leftSlab.className = 'slab-visual';
            leftSlab.style.height = slabPx + 'px';
            leftSlab.style.top = (topOffset + offsetPx) + 'px'; 
            leftSlab.innerText = "é™æ¿";
            leftStruct.appendChild(leftSlab);
        } 
        else if (offsetVal < 0) {
            var leftSlab = document.createElement('div');
            leftSlab.className = 'slab-visual';
            leftSlab.style.height = slabPx + 'px';
            leftSlab.style.top = (topOffset + offsetPx) + 'px'; 
            leftSlab.innerText = "å‡æ¿";
            leftStruct.appendChild(leftSlab);
        }
        else {
            var leftSlab = document.createElement('div');
            leftSlab.className = 'slab-visual';
            leftSlab.style.height = slabPx + 'px';
            leftSlab.style.top = topOffset + 'px';
            leftSlab.innerText = "æ¿";
            leftStruct.appendChild(leftSlab);
        }

        var bsLineTop = topOffset + offsetPx + slabPx;
        document.getElementById('slabLine').style.top = bsLineTop + 'px';

        // èª¿æ•´æ¨™ç¤ºç·š
        document.getElementById('storyHeightDim').style.top = topOffset + 'px';
        document.getElementById('storyHeightDim').style.height = (boxHeight - topOffset) + 'px'; 
        
        var roomLineTop = Math.max(0, bsLineTop);
        document.getElementById('roomHeightDim').style.top = roomLineTop + 'px';
        document.getElementById('roomHeightDim').style.height = (boxHeight - roomLineTop) + 'px';

        document.getElementById('clearHeightDim').style.top = (topOffset + beamPx) + 'px';
        document.getElementById('clearHeightDim').style.height = (boxHeight - topOffset - beamPx) + 'px';

        var oldPipes = document.querySelectorAll('.diagram-box > .sleeve-a, .diagram-box > .sleeve-b');
        oldPipes.forEach(p => p.remove());

        var centerAPx = bsLineTop + (bsA * scale);
        var sleeveAPx = SA * scale;
        var pipeAPx = PA * scale;

        var divSA = document.createElement('div');
        divSA.className = 'sleeve-a';
        divSA.style.width = sleeveAPx + 'px';
        divSA.style.height = sleeveAPx + 'px';
        divSA.style.top = centerAPx + 'px';
        divSA.style.left = (currentMode === 'single') ? '50%' : '35%';

        // ç®¡ A é¡è‰²æ§åˆ¶
        if (isUnsafeA) {
            divSA.style.borderColor = '#c62828';
            divSA.style.backgroundColor = 'rgba(198, 40, 40, 0.4)';
        }

        var divPA = document.createElement('div');
        divPA.className = 'pipe-a';
        divPA.style.width = pipeAPx + 'px';
        divPA.style.height = pipeAPx + 'px';
        
        // æœ¬ç®¡Aä¹Ÿè®Šç´…
        if (isUnsafeA) {
            divPA.style.borderColor = '#b71c1c';
            divPA.style.backgroundColor = 'rgba(211, 47, 47, 0.9)';
        }

        divSA.appendChild(divPA);
        
        var dotA = document.createElement('div');
        dotA.className = 'center-dot';
        divSA.appendChild(dotA);

        document.getElementById('diagram').appendChild(divSA);

        if (centerAPx > bsLineTop) {
            var lineA = createBsLine(bsLineTop, centerAPx, bsA, (currentMode === 'single') ? '20%' : '15%');
            bsLayer.appendChild(lineA);
        }

        if (currentMode === 'dual') {
            var centerBPx = bsLineTop + (bsB * scale);
            var sleeveBPx = SB * scale;
            var pipeBPx = PB * scale;

            var divSB = document.createElement('div');
            divSB.className = 'sleeve-b';
            divSB.style.width = sleeveBPx + 'px';
            divSB.style.height = sleeveBPx + 'px';
            divSB.style.top = centerBPx + 'px';
            divSB.style.left = '65%'; 

            if (isUnsafeB) {
                divSB.style.borderColor = '#c62828';
                divSB.style.backgroundColor = 'rgba(198, 40, 40, 0.4)';
            }

            var divPB = document.createElement('div');
            divPB.className = 'pipe-b';
            divPB.style.width = pipeBPx + 'px';
            divPB.style.height = pipeBPx + 'px';
            
            if (isUnsafeB) {
                divPB.style.borderColor = '#b71c1c';
                divPB.style.backgroundColor = 'rgba(211, 47, 47, 0.9)';
            }

            divSB.appendChild(divPB);
            
            var dotB = document.createElement('div');
            dotB.className = 'center-dot';
            divSB.appendChild(dotB);

            document.getElementById('diagram').appendChild(divSB);

            if (centerBPx > bsLineTop) {
                var lineB = createBsLine(bsLineTop, centerBPx, bsB, '85%', true);
                bsLayer.appendChild(lineB);
            }
        }
    }

    function createBsLine(topPx, bottomPx, val, leftPos, alignRight = false) {
        var line = document.createElement('div');
        line.style.position = 'absolute';
        line.style.left = leftPos; 
        line.style.top = topPx + 'px';
        line.style.height = (bottomPx - topPx) + 'px';
        line.style.width = '2px'; 
        line.style.borderLeft = '2px dashed #d84315';
        
        var lbl = document.createElement('div');
        lbl.innerText = "B.S." + Math.round(val);
        lbl.style.position = 'absolute';
        lbl.style.top = '50%';
        if (alignRight) lbl.style.right = '5px';
        else lbl.style.left = '5px';
        
        lbl.style.color = '#d84315';
        lbl.style.fontSize = '12px';
        lbl.style.fontWeight = 'bold';
        lbl.style.transform = 'translateY(-50%)';
        lbl.style.whiteSpace = 'nowrap';
        lbl.style.background = 'rgba(255,255,255,0.8)';
        lbl.style.padding = '2px 4px';
        lbl.style.borderRadius = '4px';
        
        line.appendChild(lbl);
        return line;
    }
</script>

</body>
</html>